stages:
  - build
  - test
  - publish
  - deploy
  
variables:
  REGISTRY: gcr.io/${CI_PROJECT_PATH}

docker:build:
  stage: build
  except: [tags]
  image: docker:latest
  before_script:
    - docker pull $REGISTRY:builder || true
    - docker pull $REGISTRY:latest || true
  script:
    - docker build --target builder --cache-from=$REGISTRY:builder -t $REGISTRY:builder .
    - docker build --target runtime-image --cache-from=$REGISTRY:builder --cache-from=$REGISTRY:latest -t $REGISTRY:${CI_COMMIT_SHA} .
    - docker push $REGISTRY:builder
    - docker push $REGISTRY:${CI_COMMIT_SHA}

test:
  stage: test
  image: docker:latest
  needs: ["docker:build"]
  before_script:
    - docker pull $REGISTRY:builder || true 
  script:
    - docker run -it $REGISTRY:builder go test -i
    
publish:
  stage: publish
  except: [tags]
  before_script:
    - docker pull $REGISTRY:${CI_COMMIT_SHA}
  script:
    - docker tag $REGISTRY:${CI_COMMIT_SHA} $REGISTRY:${CI_COMMIT_REF_NAME}
    - docker push $REGISTRY:${CI_COMMIT_REF_NAME}
    
publish:tag:
  stage: publish
  only: [tags]
  before_script:
    - docker pull $REGISTRY:${CI_COMMIT_SHA}
  script:
    - docker tag $REGISTRY:${CI_COMMIT_SHA} $REGISTRY:${CI_COMMIT_TAG}
    - docker push $REGISTRY:${CI_COMMIT_TAG}
    
publish:latest:
  stage: publish
  only: [master]
  before_script:
    - docker pull $REGISTRY:${CI_COMMIT_SHA}
  script:
    - docker tag $REGISTRY:${CI_COMMIT_SHA} $REGISTRY:latest
    - docker push $REGISTRY:latest
    
deploy:
  image: kiwigrid/gcloud-kubectl-helm:3.2.1-289.0.0-250
  only: [tags]
  script:
    - helm upgrade --create-namespace --wait -i --set image.tag=${CI_COMMIT_TAG} -n demo-app demo-app .helm

deploy:manual:
  image: kiwigrid/gcloud-kubectl-helm:3.2.1-289.0.0-250
  when: manual
  except: [tags]
  script:
    - helm upgrade --create-namespace --wait -i --set image.tag=${CI_COMMIT_SHA} -n demo-app demo-app .helm
